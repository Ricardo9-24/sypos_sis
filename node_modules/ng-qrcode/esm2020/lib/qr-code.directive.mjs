import { Directive, Input, isDevMode } from "@angular/core";
import qrcode from "qrcode";
import * as i0 from "@angular/core";
const validColorRegex = /^#(?:[0-9a-fA-F]{3,4}){1,2}$/;
export class QrCodeDirective {
    constructor(viewContainerRef) {
        this.viewContainerRef = viewContainerRef;
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.errorCorrectionLevel = QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
        this.darkColor = "#000000FF";
        this.lightColor = "#FFFFFFFF";
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.margin = 16;
    }
    async ngOnChanges() {
        if (!this.value) {
            return;
        }
        if (this.version && this.version > 40) {
            console.warn("[qrCode] max version is 40, clamping");
            this.version = 40;
        }
        else if (this.version && this.version < 1) {
            console.warn("[qrCode] min version is 1, clamping");
            this.version = 1;
        }
        else if (this.version !== undefined && isNaN(this.version)) {
            console.warn("[qrCode] version should be set to a number, defaulting to auto");
            this.version = undefined;
        }
        const canvas = this.viewContainerRef.element.nativeElement;
        if (!canvas) {
            // native element not available on server side rendering
            return;
        }
        const context = canvas.getContext("2d");
        if (context) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        }
        const errorCorrectionLevel = this.errorCorrectionLevel ?? QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
        const dark = validColorRegex.test(this.darkColor) ? this.darkColor : undefined;
        const light = validColorRegex.test(this.lightColor) ? this.lightColor : undefined;
        if (isDevMode()) {
            if (!dark && this.darkColor) {
                console.error("[ng-qrcode] darkColor set to invalid value, must be RGBA hex color string, eg: #3050A1FF");
            }
            if (!light && this.lightColor) {
                console.error("[ng-qrcode] lightColor set to invalid value, must be RGBA hex color string, eg: #3050A130");
            }
        }
        await qrcode
            .toCanvas(canvas, this.value, {
            version: this.version,
            errorCorrectionLevel,
            width: this.width,
            margin: this.margin,
            color: {
                dark,
                light,
            },
        });
        const centerImageSrc = this.centerImageSrc;
        const centerImageWidth = getIntOrDefault(this.centerImageWidth, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
        const centerImageHeight = getIntOrDefault(this.centerImageHeight, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
        if (centerImageSrc && context) {
            if (!this.centerImage) {
                this.centerImage = new Image(centerImageWidth, centerImageHeight);
            }
            if (centerImageSrc !== this.centerImage?.src) {
                this.centerImage.src = centerImageSrc;
            }
            if (centerImageWidth !== this.centerImage.width) {
                this.centerImage.width = centerImageWidth;
            }
            if (centerImageHeight !== this.centerImage.height) {
                this.centerImage.height = centerImageHeight;
            }
            const centerImage = this.centerImage;
            centerImage.onload = () => {
                context.drawImage(centerImage, canvas.width / 2 - centerImageWidth / 2, canvas.height / 2 - centerImageHeight / 2, centerImageWidth, centerImageHeight);
            };
        }
    }
}
QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL = "M";
QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE = 40;
QrCodeDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.2", ngImport: i0, type: QrCodeDirective, deps: [{ token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Directive });
QrCodeDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.0.2", type: QrCodeDirective, selector: "canvas[qrCode]", inputs: { value: ["qrCode", "value"], version: ["qrCodeVersion", "version"], errorCorrectionLevel: ["qrCodeErrorCorrectionLevel", "errorCorrectionLevel"], width: "width", height: "height", darkColor: "darkColor", lightColor: "lightColor", centerImageSrc: ["qrCodeCenterImageSrc", "centerImageSrc"], centerImageWidth: ["qrCodeCenterImageWidth", "centerImageWidth"], centerImageHeight: ["qrCodeCenterImageHeight", "centerImageHeight"], margin: ["qrCodeMargin", "margin"] }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.2", ngImport: i0, type: QrCodeDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: `canvas[qrCode]`,
                }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }]; }, propDecorators: { value: [{
                type: Input,
                args: ["qrCode"]
            }], version: [{
                type: Input,
                args: ["qrCodeVersion"]
            }], errorCorrectionLevel: [{
                type: Input,
                args: ["qrCodeErrorCorrectionLevel"]
            }], width: [{
                type: Input
            }], height: [{
                type: Input
            }], darkColor: [{
                type: Input
            }], lightColor: [{
                type: Input
            }], centerImageSrc: [{
                type: Input,
                args: ["qrCodeCenterImageSrc"]
            }], centerImageWidth: [{
                type: Input,
                args: ["qrCodeCenterImageWidth"]
            }], centerImageHeight: [{
                type: Input,
                args: ["qrCodeCenterImageHeight"]
            }], margin: [{
                type: Input,
                args: ["qrCodeMargin"]
            }] } });
function getIntOrDefault(value, defaultValue) {
    if (value === undefined || value === "") {
        return defaultValue;
    }
    if (typeof value === "string") {
        return parseInt(value, 10);
    }
    return value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXItY29kZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1xcmNvZGUvc3JjL2xpYi9xci1jb2RlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQStCLE1BQU0sZUFBZSxDQUFBO0FBQ3hGLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQTs7QUFHM0IsTUFBTSxlQUFlLEdBQUcsOEJBQThCLENBQUE7QUFNdEQsTUFBTSxPQUFPLGVBQWU7SUErQjFCLFlBQ1UsZ0JBQWtDO1FBQWxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFyQjVDLDJEQUEyRDtRQUN0Qix5QkFBb0IsR0FBK0IsZUFBZSxDQUFDLDhCQUE4QixDQUFBO1FBSTdILGNBQVMsR0FBYyxXQUFXLENBQUE7UUFDbEMsZUFBVSxHQUFjLFdBQVcsQ0FBQTtRQVM1QywyREFBMkQ7UUFDcEMsV0FBTSxHQUFHLEVBQUUsQ0FBQTtJQU9sQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDZixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNmLE9BQU07U0FDUDtRQUVELElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsRUFBRTtZQUNyQyxPQUFPLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUE7WUFDcEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUE7U0FDbEI7YUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUU7WUFDM0MsT0FBTyxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFBO1lBQ25ELElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFBO1NBQ2pCO2FBQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFL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LEtBQUssRUFBRSxFQUFFO1FBQ3ZDLE9BQU8sWUFBWSxDQUFBO0tBQ3BCO0lBRUQsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDN0IsT0FBTyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0tBQzNCO0lBRUQsT0FBTyxLQUFLLENBQUE7QUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgaXNEZXZNb2RlLCBPbkNoYW5nZXMsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiXG5pbXBvcnQgcXJjb2RlIGZyb20gXCJxcmNvZGVcIlxuaW1wb3J0IHsgUXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWwsIFJHQkFDb2xvciB9IGZyb20gXCIuL3R5cGVzXCJcblxuY29uc3QgdmFsaWRDb2xvclJlZ2V4ID0gL14jKD86WzAtOWEtZkEtRl17Myw0fSl7MSwyfSQvXG5cbkBEaXJlY3RpdmUoe1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogYGNhbnZhc1txckNvZGVdYCxcbn0pXG5leHBvcnQgY2xhc3MgUXJDb2RlRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcblxuICBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9FUlJPUl9DT1JSRUNUSU9OX0xFVkVMOiBRckNvZGVFcnJvckNvcnJlY3Rpb25MZXZlbCA9IFwiTVwiXG4gIHN0YXRpYyByZWFkb25seSBERUZBVUxUX0NFTlRFUl9JTUFHRV9TSVpFID0gNDBcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLWlucHV0LXJlbmFtZVxuICBASW5wdXQoXCJxckNvZGVcIikgdmFsdWUhOiBzdHJpbmdcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLWlucHV0LXJlbmFtZVxuICBASW5wdXQoXCJxckNvZGVWZXJzaW9uXCIpIHZlcnNpb24/OiBudW1iZXJcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLWlucHV0LXJlbmFtZVxuICBASW5wdXQoXCJxckNvZGVFcnJvckNvcnJlY3Rpb25MZXZlbFwiKSBlcnJvckNvcnJlY3Rpb25MZXZlbDogUXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSBRckNvZGVEaXJlY3RpdmUuREVGQVVMVF9FUlJPUl9DT1JSRUNUSU9OX0xFVkVMXG5cbiAgQElucHV0KCkgd2lkdGg/OiBudW1iZXJcbiAgQElucHV0KCkgaGVpZ2h0PzogbnVtYmVyXG4gIEBJbnB1dCgpIGRhcmtDb2xvcjogUkdCQUNvbG9yID0gXCIjMDAwMDAwRkZcIlxuICBASW5wdXQoKSBsaWdodENvbG9yOiBSR0JBQ29sb3IgPSBcIiNGRkZGRkZGRlwiXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlQ2VudGVySW1hZ2VTcmNcIikgY2VudGVySW1hZ2VTcmM/OiBzdHJpbmdcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlQ2VudGVySW1hZ2VXaWR0aFwiKSBjZW50ZXJJbWFnZVdpZHRoPzogbnVtYmVyIHwgc3RyaW5nXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZUNlbnRlckltYWdlSGVpZ2h0XCIpIGNlbnRlckltYWdlSGVpZ2h0PzogbnVtYmVyIHwgc3RyaW5nXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlTWFyZ2luXCIpIG1hcmdpbiA9IDE2XG5cbiAgcHJpdmF0ZSBjZW50ZXJJbWFnZT86IEhUTUxJbWFnZUVsZW1lbnRcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZpZXdDb250YWluZXJSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICkge1xuICB9XG5cbiAgYXN5bmMgbmdPbkNoYW5nZXMoKSB7XG4gICAgaWYgKCF0aGlzLnZhbHVlKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAodGhpcy52ZXJzaW9uICYmIHRoaXMudmVyc2lvbiA+IDQwKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJbcXJDb2RlXSBtYXggdmVyc2lvbiBpcyA0MCwgY2xhbXBpbmdcIilcbiAgICAgIHRoaXMudmVyc2lvbiA9IDQwXG4gICAgfSBlbHNlIGlmICh0aGlzLnZlcnNpb24gJiYgdGhpcy52ZXJzaW9uIDwgMSkge1xuICAgICAgY29uc29sZS53YXJuKFwiW3FyQ29kZV0gbWluIHZlcnNpb24gaXMgMSwgY2xhbXBpbmdcIilcbiAgICAgIHRoaXMudmVyc2lvbiA9IDFcbiAgICB9IGVsc2UgaWYgKHRoaXMudmVyc2lvbiAhPT0gdW5kZWZpbmVkICYmIGlzTmFOKHRoaXMudmVyc2lvbikpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIltxckNvZGVdIHZlcnNpb24gc2hvdWxkIGJlIHNldCB0byBhIG51bWJlciwgZGVmYXVsdGluZyB0byBhdXRvXCIpXG4gICAgICB0aGlzLnZlcnNpb24gPSB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBjb25zdCBjYW52YXMgPSB0aGlzLnZpZXdDb250YWluZXJSZWYuZWxlbWVudC5uYXRpdmVFbGVtZW50IGFzIEhUTUxDYW52YXNFbGVtZW50IHwgbnVsbFxuXG4gICAgaWYgKCFjYW52YXMpIHtcbiAgICAgIC8vIG5hdGl2ZSBlbGVtZW50IG5vdCBhdmFpbGFibGUgb24gc2VydmVyIHNpZGUgcmVuZGVyaW5nXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKVxuXG4gICAgaWYgKGNvbnRleHQpIHtcbiAgICAgIGNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNvbnRleHQuY2FudmFzLndpZHRoLCBjb250ZXh0LmNhbnZhcy5oZWlnaHQpXG4gICAgfVxuXG4gICAgY29uc3QgZXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSB0aGlzLmVycm9yQ29ycmVjdGlvbkxldmVsID8/IFFyQ29kZURpcmVjdGl2ZS5ERUZBVUxUX0VSUk9SX0NPUlJFQ1RJT05fTEVWRUxcblxuICAgIGNvbnN0IGRhcmsgPSB2YWxpZENvbG9yUmVnZXgudGVzdCh0aGlzLmRhcmtDb2xvcikgPyB0aGlzLmRhcmtDb2xvciA6IHVuZGVmaW5lZFxuICAgIGNvbnN0IGxpZ2h0ID0gdmFsaWRDb2xvclJlZ2V4LnRlc3QodGhpcy5saWdodENvbG9yKSA/IHRoaXMubGlnaHRDb2xvciA6IHVuZGVmaW5lZFxuXG4gICAgaWYgKGlzRGV2TW9kZSgpKSB7XG4gICAgICBpZiAoIWRhcmsgJiYgdGhpcy5kYXJrQ29sb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIltuZy1xcmNvZGVdIGRhcmtDb2xvciBzZXQgdG8gaW52YWxpZCB2YWx1ZSwgbXVzdCBiZSBSR0JBIGhleCBjb2xvciBzdHJpbmcsIGVnOiAjMzA1MEExRkZcIilcbiAgICAgIH1cblxuICAgICAgaWYgKCFsaWdodCAmJiB0aGlzLmxpZ2h0Q29sb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIltuZy1xcmNvZGVdIGxpZ2h0Q29sb3Igc2V0IHRvIGludmFsaWQgdmFsdWUsIG11c3QgYmUgUkdCQSBoZXggY29sb3Igc3RyaW5nLCBlZzogIzMwNTBBMTMwXCIpXG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IHFyY29kZVxuICAgICAgLnRvQ2FudmFzKGNhbnZhcywgdGhpcy52YWx1ZSwge1xuICAgICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sXG4gICAgICAgIGVycm9yQ29ycmVjdGlvbkxldmVsLFxuICAgICAgICB3aWR0aDogdGhpcy53aWR0aCxcbiAgICAgICAgbWFyZ2luOiB0aGlzLm1hcmdpbixcbiAgICAgICAgY29sb3I6IHtcbiAgICAgICAgICBkYXJrLFxuICAgICAgICAgIGxpZ2h0LFxuICAgICAgICB9LFxuICAgICAgfSlcblxuICAgIGNvbnN0IGNlbnRlckltYWdlU3JjID0gdGhpcy5jZW50ZXJJbWFnZVNyY1xuICAgIGNvbnN0IGNlbnRlckltYWdlV2lkdGggPSBnZXRJbnRPckRlZmF1bHQodGhpcy5jZW50ZXJJbWFnZVdpZHRoLCBRckNvZGVEaXJlY3RpdmUuREVGQVVMVF9DRU5URVJfSU1BR0VfU0laRSlcbiAgICBjb25zdCBjZW50ZXJJbWFnZUhlaWdodCA9IGdldEludE9yRGVmYXVsdCh0aGlzLmNlbnRlckltYWdlSGVpZ2h0LCBRckNvZGVEaXJlY3RpdmUuREVGQVVMVF9DRU5URVJfSU1BR0VfU0laRSlcblxuICAgIGlmIChjZW50ZXJJbWFnZVNyYyAmJiBjb250ZXh0KSB7XG5cbiAgICAgIGlmICghdGhpcy5jZW50ZXJJbWFnZSkge1xuICAgICAgICB0aGlzLmNlbnRlckltYWdlID0gbmV3IEltYWdlKGNlbnRlckltYWdlV2lkdGgsIGNlbnRlckltYWdlSGVpZ2h0KVxuICAgICAgfVxuXG4gICAgICBpZiAoY2VudGVySW1hZ2VTcmMgIT09IHRoaXMuY2VudGVySW1hZ2U/LnNyYykge1xuICAgICAgICB0aGlzLmNlbnRlckltYWdlLnNyYyA9IGNlbnRlckltYWdlU3JjXG4gICAgICB9XG5cbiAgICAgIGlmIChjZW50ZXJJbWFnZVdpZHRoICE9PSB0aGlzLmNlbnRlckltYWdlLndpZHRoKSB7XG4gICAgICAgIHRoaXMuY2VudGVySW1hZ2Uud2lkdGggPSBjZW50ZXJJbWFnZVdpZHRoXG4gICAgICB9XG5cbiAgICAgIGlmIChjZW50ZXJJbWFnZUhlaWdodCAhPT0gdGhpcy5jZW50ZXJJbWFnZS5oZWlnaHQpIHtcbiAgICAgICAgdGhpcy5jZW50ZXJJbWFnZS5oZWlnaHQgPSBjZW50ZXJJbWFnZUhlaWdodFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjZW50ZXJJbWFnZSA9IHRoaXMuY2VudGVySW1hZ2VcblxuICAgICAgY2VudGVySW1hZ2Uub25sb2FkID0gKCkgPT4ge1xuICAgICAgICBjb250ZXh0LmRyYXdJbWFnZShcbiAgICAgICAgICBjZW50ZXJJbWFnZSxcbiAgICAgICAgICBjYW52YXMud2lkdGggLyAyIC0gY2VudGVySW1hZ2VXaWR0aCAvIDIsXG4gICAgICAgICAgY2FudmFzLmhlaWdodCAvIDIgLSBjZW50ZXJJbWFnZUhlaWdodCAvIDIsIGNlbnRlckltYWdlV2lkdGgsIGNlbnRlckltYWdlSGVpZ2h0LFxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuXG4gIH1cblxufVxuXG5mdW5jdGlvbiBnZXRJbnRPckRlZmF1bHQodmFsdWU6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCwgZGVmYXVsdFZhbHVlOiBudW1iZXIpOiBudW1iZXIge1xuICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gXCJcIikge1xuICAgIHJldHVybiBkZWZhdWx0VmFsdWVcbiAgfVxuXG4gIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKVxuICB9XG5cbiAgcmV0dXJuIHZhbHVlXG59XG4iXX0=