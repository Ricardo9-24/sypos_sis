import { EventEmitter, Injectable } from '@angular/core';
import { from, fromEvent, throwError } from 'rxjs';
import { filter, map, mergeMap, takeUntil } from 'rxjs/operators';
import { ConsoleLoggerService } from './logger.service';
import { BrowserWebBluetooth } from './platform/browser';
import * as i0 from "@angular/core";
import * as i1 from "./platform/browser";
import * as i2 from "./logger.service";
export class BluetoothCore {
    constructor(webBle, console) {
        this.webBle = webBle;
        this.console = console;
        this.device$ = new EventEmitter();
        this.gatt$ = new EventEmitter();
        this.characteristicValueChanges$ = new EventEmitter();
        this.gattServer = null;
    }
    getDevice$() {
        return this.device$;
    }
    getGATT$() {
        return this.gatt$;
    }
    streamValues$() {
        return this.characteristicValueChanges$.pipe(filter(value => value && value.byteLength > 0));
    }
    /**
     * Run the discovery process and read the value form the provided service and characteristic
     * @param options the ReadValueOptions
     */
    async value(options) {
        this.console.log('[BLE::Info] Reading value with options %o', options);
        if (typeof options.acceptAllDevices === 'undefined') {
            options.acceptAllDevices = true;
        }
        if (typeof options.optionalServices === 'undefined') {
            options.optionalServices = [options.service];
        }
        else {
            options.optionalServices = [...options.optionalServices];
        }
        this.console.log('[BLE::Info] Reading value with options %o', options);
        try {
            const device = await this.discover({
                acceptAllDevices: options.acceptAllDevices,
                optionalServices: options.optionalServices
            });
            this.console.log('[BLE::Info] Device info %o', device);
            const gatt = await this.connectDevice(device);
            this.console.log('[BLE::Info] GATT info %o', gatt);
            const primaryService = await this.getPrimaryService(gatt, options.service);
            this.console.log('[BLE::Info] Primary Service info %o', primaryService);
            const characteristic = await this.getCharacteristic(primaryService, options.characteristic);
            this.console.log('[BLE::Info] Characteristic info %o', characteristic);
            const value = await characteristic.readValue();
            this.console.log('[BLE::Info] Value info %o', value);
            return value;
        }
        catch (error) {
            throw new Error(error);
        }
    }
    value$(options) {
        return from(this.value(options));
    }
    /**
     * Run the discovery process.
     *
     * @param Options such as filters and optional services
     * @return  The GATT server for the chosen device
     */
    async discover(options = {}) {
        options.optionalServices = options.optionalServices || ['generic_access'];
        this.console.log('[BLE::Info] Requesting devices with options %o', options);
        let device = null;
        try {
            device = await this.webBle.requestDevice(options);
            device.addEventListener('gattserverdisconnected', this.onDeviceDisconnected.bind(this));
            if (device) {
                this.device$.emit(device);
            }
            else {
                this.device$.error(`[BLE::Error] Can not get the Bluetooth Remote GATT Server. Abort.`);
            }
        }
        catch (error) {
            this.console.error(error);
        }
        return device;
    }
    /**
     * This handler will trigger when the client disconnets from the server.
     *
     * @param event The onDeviceDisconnected event
     */
    onDeviceDisconnected(event) {
        const disconnectedDevice = event.target;
        this.console.log('[BLE::Info] disconnected device %o', disconnectedDevice);
        this.device$.emit(null);
    }
    /**
     * Run the discovery process.
     *
     * @param Options such as filters and optional services
     * @return  Emites the value of the requested service read from the device
     */
    discover$(options) {
        return from(this.discover(options)).pipe(mergeMap((device) => this.connectDevice$(device)));
    }
    /**
     * Connect to current device.
     *
     * @return  Emites the gatt server instance of the requested device
     */
    async connectDevice(device) {
        if (device) {
            this.console.log('[BLE::Info] Connecting to Bluetooth Remote GATT Server of %o', device);
            try {
                const gattServer = await device.gatt.connect();
                this.gattServer = gattServer;
                this.gatt$.emit(gattServer);
                return gattServer;
            }
            catch (error) {
                // probably the user has canceled the discovery
                Promise.reject(`${error.message}`);
                this.gatt$.error(`${error.message}`);
            }
        }
        else {
            this.console.error('[BLE::Error] Was not able to connect to Bluetooth Remote GATT Server');
            this.gatt$.error(null);
        }
    }
    /**
     * Connect to current device.
     *
     * @return  Emites the gatt server instance of the requested device
     */
    connectDevice$(device) {
        return from(this.connectDevice(device));
    }
    /**
     * Disconnect the current connected device
     */
    disconnectDevice() {
        if (!this.gattServer) {
            return;
        }
        this.console.log('[BLE::Info] Disconnecting from Bluetooth Device %o', this.gattServer);
        if (this.gattServer.connected) {
            this.gattServer.disconnect();
        }
        else {
            this.console.log('[BLE::Info] Bluetooth device is already disconnected');
        }
    }
    /**
     * Requests the primary service.
     *
     * @param gatt The BluetoothRemoteGATTServer sever
     * @param service The UUID of the primary service
     * @return The remote service (as a Promise)
     */
    async getPrimaryService(gatt, service) {
        try {
            const remoteService = await gatt.getPrimaryService(service);
            return await Promise.resolve(remoteService);
        }
        catch (error) {
            return await Promise.reject(`${error.message} (${service})`);
        }
    }
    /**
     * Requests the primary service.
     *
     * @param gatt The BluetoothRemoteGATTServer sever
     * @param service The UUID of the primary service
     * @return The remote service (as an observable).
     */
    getPrimaryService$(gatt, service) {
        this.console.log('[BLE::Info] Getting primary service "%s" (if available) of %o', service, gatt);
        if (gatt) {
            return from(this.getPrimaryService(gatt, service));
        }
        else {
            return throwError(new Error('[BLE::Error] Was not able to connect to the Bluetooth Remote GATT Server'));
        }
    }
    /**
     * Requests a characteristic from the primary service.
     *
     * @param primaryService The primary service.
     * @param characteristic The characteristic's UUID.
     * @returns The characteristic description (as a Promise).
     */
    async getCharacteristic(primaryService, characteristic) {
        this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
        try {
            const char = await primaryService.getCharacteristic(characteristic);
            // listen for characteristic value changes
            if (char.properties.notify) {
                char.startNotifications().then(_ => {
                    this.console.log('[BLE::Info] Starting notifications of "%s"', characteristic);
                    char.addEventListener('characteristicvaluechanged', this.onCharacteristicChanged.bind(this));
                }, (error) => {
                    Promise.reject(`${error.message} (${characteristic})`);
                });
            }
            else {
                char.addEventListener('characteristicvaluechanged', this.onCharacteristicChanged.bind(this));
            }
            return char;
        }
        catch (rejectionError) {
            Promise.reject(`${rejectionError.message} (${characteristic})`);
        }
    }
    /**
     * Requests a characteristic from the primary service.
     *
     * @param primaryService The primary service.
     * @param characteristic The characteristic's UUID.
     * @returns The characteristic description (as a Observable).
     */
    getCharacteristic$(primaryService, characteristic) {
        this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
        return from(this.getCharacteristic(primaryService, characteristic));
    }
    /**
     * Sets the characteristic's state.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic
     * @param state An ArrayBuffer containing the value of the characteristic.
     * @return The primary service (useful for chaining).
     */
    setCharacteristicState(service, characteristic, state) {
        const primaryService = this.getPrimaryService$(this.gattServer, service);
        primaryService
            // tslint:disable-next-line: variable-name
            .pipe(mergeMap((_primaryService) => this.getCharacteristic$(_primaryService, characteristic)))
            // tslint:disable-next-line: no-shadowed-variable
            .subscribe((characteristic) => this.writeValue$(characteristic, state));
        return primaryService;
    }
    /**
     * Enables the specified characteristic of a given service.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic
     * @return The primary service (useful for chaining).
     */
    enableCharacteristic(service, characteristic, state) {
        state = state || new Uint8Array([1]);
        return this.setCharacteristicState(service, characteristic, state);
    }
    /**
     * Disables the specified characteristic of a given service.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic.
     * @return The primary service (useful for chaining).
     */
    disbaleCharacteristic(service, characteristic, state) {
        state = state || new Uint8Array([0]);
        return this.setCharacteristicState(service, characteristic, state);
    }
    /**
     * Dispatches new values emitted by a characteristic.
     *
     * @param event the distpatched event.
     */
    onCharacteristicChanged(event) {
        this.console.log('[BLE::Info] Dispatching new characteristic value %o', event);
        const value = event.target.value;
        this.characteristicValueChanges$.emit(value);
    }
    /**
     * Reads a value from the characteristics, as a DataView.
     *
     * @param characteristic The requested characteristic.
     * @return the DataView value (as an Observable).
     */
    readValue$(characteristic) {
        this.console.log('[BLE::Info] Reading Characteristic %o', characteristic);
        return from(characteristic
            .readValue()
            .then((data) => Promise.resolve(data), (error) => Promise.reject(`${error.message}`)));
    }
    /**
     * Writes a value into the specified characteristic.
     *
     * @param characteristic The requested characteristic.
     * @param value The value to be written (as an ArrayBuffer or Uint8Array).
     * @return an void Observable.
     */
    writeValue$(characteristic, value) {
        this.console.log('[BLE::Info] Writing Characteristic %o', characteristic);
        return from(characteristic.writeValue(value).then(_ => Promise.resolve(), (error) => Promise.reject(`${error.message}`)));
    }
    /**
     * A stream of DataView values emitted by the specified characteristic.
     *
     * @param characteristic The characteristic which value you want to observe
     * @return The stream of DataView values.
     */
    observeValue$(characteristic) {
        characteristic.startNotifications();
        const disconnected = fromEvent(characteristic.service.device, 'gattserverdisconnected');
        return fromEvent(characteristic, 'characteristicvaluechanged')
            .pipe(map((event) => event.target.value), takeUntil(disconnected));
    }
    /**
     * A utility method to convert LE to an unsigned 16-bit integer values.
     *
     * @param data The DataView binary data.
     * @param byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return An unsigned 16-bit integer number.
     */
    littleEndianToUint16(data, byteOffset) {
        // tslint:disable-next-line:no-bitwise
        return (this.littleEndianToUint8(data, byteOffset + 1) << 8) + this.littleEndianToUint8(data, byteOffset);
    }
    /**
     * A utility method to convert LE to an unsigned 8-bit integer values.
     *
     * @param data The DataView binary data.
     * @param byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return An unsigned 8-bit integer number.
     */
    littleEndianToUint8(data, byteOffset) {
        return data.getUint8(byteOffset);
    }
    /**
     * Sends random data (for testing purposes only).
     *
     * @return Random unsigned 8-bit integer values.
     */
    fakeNext(fakeValue) {
        if (fakeValue === undefined) {
            fakeValue = () => {
                const dv = new DataView(new ArrayBuffer(8));
                // tslint:disable-next-line:no-bitwise
                dv.setUint8(0, (Math.random() * 110) | 0);
                return dv;
            };
        }
        this.characteristicValueChanges$.emit(fakeValue());
    }
}
/** @nocollapse */ BluetoothCore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.5", ngImport: i0, type: BluetoothCore, deps: [{ token: i1.BrowserWebBluetooth }, { token: i2.ConsoleLoggerService }], target: i0.ɵɵFactoryTarget.Injectable });
/** @nocollapse */ BluetoothCore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.5", ngImport: i0, type: BluetoothCore, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.5", ngImport: i0, type: BluetoothCore, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.BrowserWebBluetooth }, { type: i2.ConsoleLoggerService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmx1ZXRvb3RoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9tYW5la2luZWtrby9hbmd1bGFyLXdlYi1ibHVldG9vdGgvc3JjL2xpYi9ibHVldG9vdGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDOzs7O0FBWXpELE1BQU0sT0FBTyxhQUFhO0lBTXhCLFlBQTZCLE1BQTJCLEVBQW1CLE9BQTZCO1FBQTNFLFdBQU0sR0FBTixNQUFNLENBQXFCO1FBQW1CLFlBQU8sR0FBUCxPQUFPLENBQXNCO1FBRXRHLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFDbkQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUMzRCxJQUFJLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxZQUFZLEVBQVksQ0FBQztRQUVoRSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztJQUN6QixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLDJCQUEyQixDQUFDLElB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SUFFRDs7Ozs7O09BTUc7SUFDSCxvQkFBb0IsQ0FBQyxJQUFTLEVBQUUsVUFBa0I7UUFDaEQsc0NBQXNDO1FBQ3RDLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFVBQVUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzVHLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCxtQkFBbUIsQ0FBQyxJQUFTLEVBQUUsVUFBa0I7UUFDL0MsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsUUFBUSxDQUFDLFNBQTBCO1FBQ2pDLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtZQUMzQixTQUFTLEdBQUcsR0FBRyxFQUFFO2dCQUNmLE1BQU0sRUFBRSxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVDLHNDQUFzQztnQkFDdEMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQyxDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQzs7NkhBdlpVLGFBQWE7aUlBQWIsYUFBYSxjQUZaLE1BQU07MkZBRVAsYUFBYTtrQkFIekIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZnJvbSwgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtZXJnZU1hcCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBDb25zb2xlTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vbG9nZ2VyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBCcm93c2VyV2ViQmx1ZXRvb3RoIH0gZnJvbSAnLi9wbGF0Zm9ybS9icm93c2VyJztcclxuXHJcbnR5cGUgUmVhZFZhbHVlT3B0aW9ucyA9IHtcclxuICBhY2NlcHRBbGxEZXZpY2VzPzogYm9vbGVhbjtcclxuICBvcHRpb25hbFNlcnZpY2VzPzogQmx1ZXRvb3RoU2VydmljZVVVSURbXTtcclxuICBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELFxyXG4gIHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELFxyXG59O1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgQmx1ZXRvb3RoQ29yZSB7XHJcbiAgcHJpdmF0ZSBkZXZpY2UkOiBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoRGV2aWNlPjtcclxuICBwcml2YXRlIGdhdHQkOiBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj47XHJcbiAgcHJpdmF0ZSBjaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQ6IEV2ZW50RW1pdHRlcjxEYXRhVmlldz47XHJcbiAgcHJpdmF0ZSBnYXR0U2VydmVyOiBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHdlYkJsZTogQnJvd3NlcldlYkJsdWV0b290aCwgcHJpdmF0ZSByZWFkb25seSBjb25zb2xlOiBDb25zb2xlTG9nZ2VyU2VydmljZSkge1xyXG5cclxuICAgIHRoaXMuZGV2aWNlJCA9IG5ldyBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoRGV2aWNlPigpO1xyXG4gICAgdGhpcy5nYXR0JCA9IG5ldyBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj4oKTtcclxuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkID0gbmV3IEV2ZW50RW1pdHRlcjxEYXRhVmlldz4oKTtcclxuXHJcbiAgICB0aGlzLmdhdHRTZXJ2ZXIgPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0RGV2aWNlJCgpOiBPYnNlcnZhYmxlPEJsdWV0b290aERldmljZT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZGV2aWNlJDtcclxuICB9XHJcblxyXG4gIGdldEdBVFQkKCk6IE9ic2VydmFibGU8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2F0dCQ7XHJcbiAgfVxyXG5cclxuICBzdHJlYW1WYWx1ZXMkKCk6IE9ic2VydmFibGU8RGF0YVZpZXc+IHtcclxuICAgIHJldHVybiB0aGlzLmNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VzJC5waXBlKGZpbHRlcih2YWx1ZSA9PiB2YWx1ZSAmJiB2YWx1ZS5ieXRlTGVuZ3RoID4gMCkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUnVuIHRoZSBkaXNjb3ZlcnkgcHJvY2VzcyBhbmQgcmVhZCB0aGUgdmFsdWUgZm9ybSB0aGUgcHJvdmlkZWQgc2VydmljZSBhbmQgY2hhcmFjdGVyaXN0aWNcclxuICAgKiBAcGFyYW0gb3B0aW9ucyB0aGUgUmVhZFZhbHVlT3B0aW9uc1xyXG4gICAqL1xyXG4gIGFzeW5jIHZhbHVlKG9wdGlvbnM6IFJlYWRWYWx1ZU9wdGlvbnMpIHtcclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgdmFsdWUgd2l0aCBvcHRpb25zICVvJywgb3B0aW9ucyk7XHJcblxyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmFjY2VwdEFsbERldmljZXMgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIG9wdGlvbnMuYWNjZXB0QWxsRGV2aWNlcyA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIG9wdGlvbnMub3B0aW9uYWxTZXJ2aWNlcyA9IFtvcHRpb25zLnNlcnZpY2VdO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIG9wdGlvbnMub3B0aW9uYWxTZXJ2aWNlcyA9IFsuLi5vcHRpb25zLm9wdGlvbmFsU2VydmljZXNdO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgdmFsdWUgd2l0aCBvcHRpb25zICVvJywgb3B0aW9ucyk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZGV2aWNlID0gYXdhaXQgdGhpcy5kaXNjb3Zlcih7XHJcbiAgICAgICAgYWNjZXB0QWxsRGV2aWNlczogb3B0aW9ucy5hY2NlcHRBbGxEZXZpY2VzLFxyXG4gICAgICAgIG9wdGlvbmFsU2VydmljZXM6IG9wdGlvbnMub3B0aW9uYWxTZXJ2aWNlc1xyXG4gICAgICB9KSBhcyBCbHVldG9vdGhEZXZpY2U7XHJcbiAgICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIERldmljZSBpbmZvICVvJywgZGV2aWNlKTtcclxuXHJcbiAgICAgIGNvbnN0IGdhdHQgPSBhd2FpdCB0aGlzLmNvbm5lY3REZXZpY2UoZGV2aWNlKTtcclxuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR0FUVCBpbmZvICVvJywgZ2F0dCk7XHJcblxyXG4gICAgICBjb25zdCBwcmltYXJ5U2VydmljZSA9IGF3YWl0IHRoaXMuZ2V0UHJpbWFyeVNlcnZpY2UoZ2F0dCwgb3B0aW9ucy5zZXJ2aWNlKSBhcyBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmljZTtcclxuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gUHJpbWFyeSBTZXJ2aWNlIGluZm8gJW8nLCBwcmltYXJ5U2VydmljZSk7XHJcblxyXG4gICAgICBjb25zdCBjaGFyYWN0ZXJpc3RpYyA9IGF3YWl0IHRoaXMuZ2V0Q2hhcmFjdGVyaXN0aWMocHJpbWFyeVNlcnZpY2UsIG9wdGlvbnMuY2hhcmFjdGVyaXN0aWMpIGFzIEJsdWV0b290aFJlbW90ZUdBVFRDaGFyYWN0ZXJpc3RpYztcclxuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gQ2hhcmFjdGVyaXN0aWMgaW5mbyAlbycsIGNoYXJhY3RlcmlzdGljKTtcclxuXHJcbiAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY2hhcmFjdGVyaXN0aWMucmVhZFZhbHVlKCk7XHJcbiAgICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFZhbHVlIGluZm8gJW8nLCB2YWx1ZSk7XHJcblxyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHZhbHVlJChvcHRpb25zOiBSZWFkVmFsdWVPcHRpb25zKSB7XHJcbiAgICByZXR1cm4gZnJvbSh0aGlzLnZhbHVlKG9wdGlvbnMpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJ1biB0aGUgZGlzY292ZXJ5IHByb2Nlc3MuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gT3B0aW9ucyBzdWNoIGFzIGZpbHRlcnMgYW5kIG9wdGlvbmFsIHNlcnZpY2VzXHJcbiAgICogQHJldHVybiAgVGhlIEdBVFQgc2VydmVyIGZvciB0aGUgY2hvc2VuIGRldmljZVxyXG4gICAqL1xyXG4gIGFzeW5jIGRpc2NvdmVyKG9wdGlvbnM6IFJlcXVlc3REZXZpY2VPcHRpb25zID0ge30gYXMgUmVxdWVzdERldmljZU9wdGlvbnMpOiBQcm9taXNlPEJsdWV0b290aERldmljZT4ge1xyXG4gICAgb3B0aW9ucy5vcHRpb25hbFNlcnZpY2VzID0gb3B0aW9ucy5vcHRpb25hbFNlcnZpY2VzIHx8IFsnZ2VuZXJpY19hY2Nlc3MnXTtcclxuXHJcbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBSZXF1ZXN0aW5nIGRldmljZXMgd2l0aCBvcHRpb25zICVvJywgb3B0aW9ucyk7XHJcblxyXG4gICAgbGV0IGRldmljZSA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBkZXZpY2UgPSBhd2FpdCB0aGlzLndlYkJsZS5yZXF1ZXN0RGV2aWNlKG9wdGlvbnMpO1xyXG4gICAgICBkZXZpY2UuYWRkRXZlbnRMaXN0ZW5lcignZ2F0dHNlcnZlcmRpc2Nvbm5lY3RlZCcsIHRoaXMub25EZXZpY2VEaXNjb25uZWN0ZWQuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgICBpZiAoZGV2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5kZXZpY2UkLmVtaXQoZGV2aWNlKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICB0aGlzLmRldmljZSQuZXJyb3IoYFtCTEU6OkVycm9yXSBDYW4gbm90IGdldCB0aGUgQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlci4gQWJvcnQuYCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBkZXZpY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUaGlzIGhhbmRsZXIgd2lsbCB0cmlnZ2VyIHdoZW4gdGhlIGNsaWVudCBkaXNjb25uZXRzIGZyb20gdGhlIHNlcnZlci5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBldmVudCBUaGUgb25EZXZpY2VEaXNjb25uZWN0ZWQgZXZlbnRcclxuICAgKi9cclxuICBvbkRldmljZURpc2Nvbm5lY3RlZChldmVudDogRXZlbnQpIHtcclxuICAgIGNvbnN0IGRpc2Nvbm5lY3RlZERldmljZSA9IGV2ZW50LnRhcmdldCBhcyBCbHVldG9vdGhEZXZpY2U7XHJcbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBkaXNjb25uZWN0ZWQgZGV2aWNlICVvJywgZGlzY29ubmVjdGVkRGV2aWNlKTtcclxuXHJcbiAgICB0aGlzLmRldmljZSQuZW1pdChudWxsKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJ1biB0aGUgZGlzY292ZXJ5IHByb2Nlc3MuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gT3B0aW9ucyBzdWNoIGFzIGZpbHRlcnMgYW5kIG9wdGlvbmFsIHNlcnZpY2VzXHJcbiAgICogQHJldHVybiAgRW1pdGVzIHRoZSB2YWx1ZSBvZiB0aGUgcmVxdWVzdGVkIHNlcnZpY2UgcmVhZCBmcm9tIHRoZSBkZXZpY2VcclxuICAgKi9cclxuICBkaXNjb3ZlciQob3B0aW9ucz86IFJlcXVlc3REZXZpY2VPcHRpb25zKTogT2JzZXJ2YWJsZTx2b2lkIHwgQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj4ge1xyXG4gICAgcmV0dXJuIGZyb20odGhpcy5kaXNjb3ZlcihvcHRpb25zKSkucGlwZShtZXJnZU1hcCgoZGV2aWNlOiBCbHVldG9vdGhEZXZpY2UpID0+IHRoaXMuY29ubmVjdERldmljZSQoZGV2aWNlKSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29ubmVjdCB0byBjdXJyZW50IGRldmljZS5cclxuICAgKlxyXG4gICAqIEByZXR1cm4gIEVtaXRlcyB0aGUgZ2F0dCBzZXJ2ZXIgaW5zdGFuY2Ugb2YgdGhlIHJlcXVlc3RlZCBkZXZpY2VcclxuICAgKi9cclxuICBhc3luYyBjb25uZWN0RGV2aWNlKGRldmljZTogQmx1ZXRvb3RoRGV2aWNlKSB7XHJcbiAgICBpZiAoZGV2aWNlKSB7XHJcbiAgICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIENvbm5lY3RpbmcgdG8gQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlciBvZiAlbycsIGRldmljZSk7XHJcblxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGdhdHRTZXJ2ZXIgPSBhd2FpdCBkZXZpY2UuZ2F0dC5jb25uZWN0KCk7XHJcbiAgICAgICAgdGhpcy5nYXR0U2VydmVyID0gZ2F0dFNlcnZlcjtcclxuICAgICAgICB0aGlzLmdhdHQkLmVtaXQoZ2F0dFNlcnZlcik7XHJcbiAgICAgICAgcmV0dXJuIGdhdHRTZXJ2ZXI7XHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgLy8gcHJvYmFibHkgdGhlIHVzZXIgaGFzIGNhbmNlbGVkIHRoZSBkaXNjb3ZlcnlcclxuICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgICAgIHRoaXMuZ2F0dCQuZXJyb3IoYCR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jb25zb2xlLmVycm9yKCdbQkxFOjpFcnJvcl0gV2FzIG5vdCBhYmxlIHRvIGNvbm5lY3QgdG8gQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlcicpO1xyXG4gICAgICB0aGlzLmdhdHQkLmVycm9yKG51bGwpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29ubmVjdCB0byBjdXJyZW50IGRldmljZS5cclxuICAgKlxyXG4gICAqIEByZXR1cm4gIEVtaXRlcyB0aGUgZ2F0dCBzZXJ2ZXIgaW5zdGFuY2Ugb2YgdGhlIHJlcXVlc3RlZCBkZXZpY2VcclxuICAgKi9cclxuICBjb25uZWN0RGV2aWNlJChkZXZpY2U6IEJsdWV0b290aERldmljZSkge1xyXG4gICAgcmV0dXJuIGZyb20odGhpcy5jb25uZWN0RGV2aWNlKGRldmljZSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGlzY29ubmVjdCB0aGUgY3VycmVudCBjb25uZWN0ZWQgZGV2aWNlXHJcbiAgICovXHJcbiAgZGlzY29ubmVjdERldmljZSgpIHtcclxuICAgIGlmICghdGhpcy5nYXR0U2VydmVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIERpc2Nvbm5lY3RpbmcgZnJvbSBCbHVldG9vdGggRGV2aWNlICVvJywgdGhpcy5nYXR0U2VydmVyKTtcclxuXHJcbiAgICBpZiAodGhpcy5nYXR0U2VydmVyLmNvbm5lY3RlZCkge1xyXG4gICAgICB0aGlzLmdhdHRTZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gQmx1ZXRvb3RoIGRldmljZSBpcyBhbHJlYWR5IGRpc2Nvbm5lY3RlZCcpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVxdWVzdHMgdGhlIHByaW1hcnkgc2VydmljZS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBnYXR0IFRoZSBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyIHNldmVyXHJcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIFVVSUQgb2YgdGhlIHByaW1hcnkgc2VydmljZVxyXG4gICAqIEByZXR1cm4gVGhlIHJlbW90ZSBzZXJ2aWNlIChhcyBhIFByb21pc2UpXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0UHJpbWFyeVNlcnZpY2UoZ2F0dDogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlciwgc2VydmljZTogQmx1ZXRvb3RoU2VydmljZVVVSUQpOiBQcm9taXNlPEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZW1vdGVTZXJ2aWNlID0gYXdhaXQgZ2F0dC5nZXRQcmltYXJ5U2VydmljZShzZXJ2aWNlKTtcclxuICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UucmVzb2x2ZShyZW1vdGVTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5yZWplY3QoYCR7ZXJyb3IubWVzc2FnZX0gKCR7c2VydmljZX0pYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXF1ZXN0cyB0aGUgcHJpbWFyeSBzZXJ2aWNlLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGdhdHQgVGhlIEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXIgc2V2ZXJcclxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgVVVJRCBvZiB0aGUgcHJpbWFyeSBzZXJ2aWNlXHJcbiAgICogQHJldHVybiBUaGUgcmVtb3RlIHNlcnZpY2UgKGFzIGFuIG9ic2VydmFibGUpLlxyXG4gICAqL1xyXG4gIGdldFByaW1hcnlTZXJ2aWNlJChnYXR0OiBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyLCBzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCk6IE9ic2VydmFibGU8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2U+IHtcclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIEdldHRpbmcgcHJpbWFyeSBzZXJ2aWNlIFwiJXNcIiAoaWYgYXZhaWxhYmxlKSBvZiAlbycsIHNlcnZpY2UsIGdhdHQpO1xyXG5cclxuXHJcbiAgICBpZiAoZ2F0dCkge1xyXG4gICAgICByZXR1cm4gZnJvbShcclxuICAgICAgICB0aGlzLmdldFByaW1hcnlTZXJ2aWNlKGdhdHQsIHNlcnZpY2UpXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRocm93RXJyb3IobmV3IEVycm9yKCdbQkxFOjpFcnJvcl0gV2FzIG5vdCBhYmxlIHRvIGNvbm5lY3QgdG8gdGhlIEJsdWV0b290aCBSZW1vdGUgR0FUVCBTZXJ2ZXInKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXF1ZXN0cyBhIGNoYXJhY3RlcmlzdGljIGZyb20gdGhlIHByaW1hcnkgc2VydmljZS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBwcmltYXJ5U2VydmljZSBUaGUgcHJpbWFyeSBzZXJ2aWNlLlxyXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMncyBVVUlELlxyXG4gICAqIEByZXR1cm5zIFRoZSBjaGFyYWN0ZXJpc3RpYyBkZXNjcmlwdGlvbiAoYXMgYSBQcm9taXNlKS5cclxuICAgKi9cclxuICBhc3luYyBnZXRDaGFyYWN0ZXJpc3RpYyhcclxuICAgIHByaW1hcnlTZXJ2aWNlOiBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmljZSxcclxuICAgIGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhDaGFyYWN0ZXJpc3RpY1VVSURcclxuICApOiBQcm9taXNlPEJsdWV0b290aFJlbW90ZUdBVFRDaGFyYWN0ZXJpc3RpYyB8IHZvaWQ+IHtcclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIEdldHRpbmcgQ2hhcmFjdGVyaXN0aWMgXCIlc1wiIG9mICVvJywgY2hhcmFjdGVyaXN0aWMsIHByaW1hcnlTZXJ2aWNlKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjaGFyID0gYXdhaXQgcHJpbWFyeVNlcnZpY2UuZ2V0Q2hhcmFjdGVyaXN0aWMoY2hhcmFjdGVyaXN0aWMpO1xyXG4gICAgICAvLyBsaXN0ZW4gZm9yIGNoYXJhY3RlcmlzdGljIHZhbHVlIGNoYW5nZXNcclxuICAgICAgaWYgKGNoYXIucHJvcGVydGllcy5ub3RpZnkpIHtcclxuICAgICAgICBjaGFyLnN0YXJ0Tm90aWZpY2F0aW9ucygpLnRoZW4oXyA9PiB7XHJcbiAgICAgICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBTdGFydGluZyBub3RpZmljYXRpb25zIG9mIFwiJXNcIicsIGNoYXJhY3RlcmlzdGljKTtcclxuICAgICAgICAgIGNoYXIuYWRkRXZlbnRMaXN0ZW5lcignY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnLCB0aGlzLm9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkLmJpbmQodGhpcykpO1xyXG4gICAgICAgIH0sIChlcnJvcjogRE9NRXhjZXB0aW9uKSA9PiB7XHJcbiAgICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfSAoJHtjaGFyYWN0ZXJpc3RpY30pYCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgY2hhci5hZGRFdmVudExpc3RlbmVyKCdjaGFyYWN0ZXJpc3RpY3ZhbHVlY2hhbmdlZCcsIHRoaXMub25DaGFyYWN0ZXJpc3RpY0NoYW5nZWQuYmluZCh0aGlzKSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGNoYXI7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAocmVqZWN0aW9uRXJyb3IpIHtcclxuICAgICAgUHJvbWlzZS5yZWplY3QoYCR7cmVqZWN0aW9uRXJyb3IubWVzc2FnZX0gKCR7Y2hhcmFjdGVyaXN0aWN9KWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVxdWVzdHMgYSBjaGFyYWN0ZXJpc3RpYyBmcm9tIHRoZSBwcmltYXJ5IHNlcnZpY2UuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gcHJpbWFyeVNlcnZpY2UgVGhlIHByaW1hcnkgc2VydmljZS5cclxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIGNoYXJhY3RlcmlzdGljJ3MgVVVJRC5cclxuICAgKiBAcmV0dXJucyBUaGUgY2hhcmFjdGVyaXN0aWMgZGVzY3JpcHRpb24gKGFzIGEgT2JzZXJ2YWJsZSkuXHJcbiAgICovXHJcbiAgZ2V0Q2hhcmFjdGVyaXN0aWMkKFxyXG4gICAgcHJpbWFyeVNlcnZpY2U6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlLFxyXG4gICAgY2hhcmFjdGVyaXN0aWM6IEJsdWV0b290aENoYXJhY3RlcmlzdGljVVVJRFxyXG4gICk6IE9ic2VydmFibGU8dm9pZCB8IEJsdWV0b290aFJlbW90ZUdBVFRDaGFyYWN0ZXJpc3RpYz4ge1xyXG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBDaGFyYWN0ZXJpc3RpYyBcIiVzXCIgb2YgJW8nLCBjaGFyYWN0ZXJpc3RpYywgcHJpbWFyeVNlcnZpY2UpO1xyXG5cclxuICAgIHJldHVybiBmcm9tKHRoaXMuZ2V0Q2hhcmFjdGVyaXN0aWMocHJpbWFyeVNlcnZpY2UsIGNoYXJhY3RlcmlzdGljKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXRzIHRoZSBjaGFyYWN0ZXJpc3RpYydzIHN0YXRlLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIHBhcmVudCBzZXJ2aWNlIG9mIHRoZSBjaGFyYWN0ZXJpc3RpYy5cclxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpY1xyXG4gICAqIEBwYXJhbSBzdGF0ZSBBbiBBcnJheUJ1ZmZlciBjb250YWluaW5nIHRoZSB2YWx1ZSBvZiB0aGUgY2hhcmFjdGVyaXN0aWMuXHJcbiAgICogQHJldHVybiBUaGUgcHJpbWFyeSBzZXJ2aWNlICh1c2VmdWwgZm9yIGNoYWluaW5nKS5cclxuICAgKi9cclxuICBzZXRDaGFyYWN0ZXJpc3RpY1N0YXRlKHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELCBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELCBzdGF0ZTogQXJyYXlCdWZmZXIpIHtcclxuICAgIGNvbnN0IHByaW1hcnlTZXJ2aWNlID0gdGhpcy5nZXRQcmltYXJ5U2VydmljZSQodGhpcy5nYXR0U2VydmVyLCBzZXJ2aWNlKTtcclxuXHJcbiAgICBwcmltYXJ5U2VydmljZVxyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHZhcmlhYmxlLW5hbWVcclxuICAgICAgLnBpcGUobWVyZ2VNYXAoKF9wcmltYXJ5U2VydmljZTogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2UpID0+IHRoaXMuZ2V0Q2hhcmFjdGVyaXN0aWMkKF9wcmltYXJ5U2VydmljZSwgY2hhcmFjdGVyaXN0aWMpKSlcclxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1zaGFkb3dlZC12YXJpYWJsZVxyXG4gICAgICAuc3Vic2NyaWJlKChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKSA9PiB0aGlzLndyaXRlVmFsdWUkKGNoYXJhY3RlcmlzdGljLCBzdGF0ZSkpO1xyXG5cclxuICAgIHJldHVybiBwcmltYXJ5U2VydmljZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEVuYWJsZXMgdGhlIHNwZWNpZmllZCBjaGFyYWN0ZXJpc3RpYyBvZiBhIGdpdmVuIHNlcnZpY2UuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgcGFyZW50IHNlcnZpY2Ugb2YgdGhlIGNoYXJhY3RlcmlzdGljLlxyXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljXHJcbiAgICogQHJldHVybiBUaGUgcHJpbWFyeSBzZXJ2aWNlICh1c2VmdWwgZm9yIGNoYWluaW5nKS5cclxuICAgKi9cclxuICBlbmFibGVDaGFyYWN0ZXJpc3RpYyhzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCwgY2hhcmFjdGVyaXN0aWM6IEJsdWV0b290aENoYXJhY3RlcmlzdGljVVVJRCwgc3RhdGU/OiBhbnkpIHtcclxuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzFdKTtcclxuICAgIHJldHVybiB0aGlzLnNldENoYXJhY3RlcmlzdGljU3RhdGUoc2VydmljZSwgY2hhcmFjdGVyaXN0aWMsIHN0YXRlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERpc2FibGVzIHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMgb2YgYSBnaXZlbiBzZXJ2aWNlLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIHBhcmVudCBzZXJ2aWNlIG9mIHRoZSBjaGFyYWN0ZXJpc3RpYy5cclxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpYy5cclxuICAgKiBAcmV0dXJuIFRoZSBwcmltYXJ5IHNlcnZpY2UgKHVzZWZ1bCBmb3IgY2hhaW5pbmcpLlxyXG4gICAqL1xyXG4gIGRpc2JhbGVDaGFyYWN0ZXJpc3RpYyhzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCwgY2hhcmFjdGVyaXN0aWM6IEJsdWV0b290aENoYXJhY3RlcmlzdGljVVVJRCwgc3RhdGU/OiBhbnkpIHtcclxuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzBdKTtcclxuICAgIHJldHVybiB0aGlzLnNldENoYXJhY3RlcmlzdGljU3RhdGUoc2VydmljZSwgY2hhcmFjdGVyaXN0aWMsIHN0YXRlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERpc3BhdGNoZXMgbmV3IHZhbHVlcyBlbWl0dGVkIGJ5IGEgY2hhcmFjdGVyaXN0aWMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZXZlbnQgdGhlIGRpc3RwYXRjaGVkIGV2ZW50LlxyXG4gICAqL1xyXG4gIG9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkKGV2ZW50OiBFdmVudCkge1xyXG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gRGlzcGF0Y2hpbmcgbmV3IGNoYXJhY3RlcmlzdGljIHZhbHVlICVvJywgZXZlbnQpO1xyXG5cclxuICAgIGNvbnN0IHZhbHVlID0gKGV2ZW50LnRhcmdldCBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpLnZhbHVlO1xyXG4gICAgdGhpcy5jaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQuZW1pdCh2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZWFkcyBhIHZhbHVlIGZyb20gdGhlIGNoYXJhY3RlcmlzdGljcywgYXMgYSBEYXRhVmlldy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljLlxyXG4gICAqIEByZXR1cm4gdGhlIERhdGFWaWV3IHZhbHVlIChhcyBhbiBPYnNlcnZhYmxlKS5cclxuICAgKi9cclxuICByZWFkVmFsdWUkKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpOiBPYnNlcnZhYmxlPERhdGFWaWV3PiB7XHJcbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBSZWFkaW5nIENoYXJhY3RlcmlzdGljICVvJywgY2hhcmFjdGVyaXN0aWMpO1xyXG5cclxuICAgIHJldHVybiBmcm9tKFxyXG4gICAgICBjaGFyYWN0ZXJpc3RpY1xyXG4gICAgICAgIC5yZWFkVmFsdWUoKVxyXG4gICAgICAgIC50aGVuKChkYXRhOiBEYXRhVmlldykgPT4gUHJvbWlzZS5yZXNvbHZlKGRhdGEpLCAoZXJyb3I6IERPTUV4Y2VwdGlvbikgPT4gUHJvbWlzZS5yZWplY3QoYCR7ZXJyb3IubWVzc2FnZX1gKSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBXcml0ZXMgYSB2YWx1ZSBpbnRvIHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpYy5cclxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4gKGFzIGFuIEFycmF5QnVmZmVyIG9yIFVpbnQ4QXJyYXkpLlxyXG4gICAqIEByZXR1cm4gYW4gdm9pZCBPYnNlcnZhYmxlLlxyXG4gICAqL1xyXG4gIHdyaXRlVmFsdWUkKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMsIHZhbHVlOiBBcnJheUJ1ZmZlciB8IFVpbnQ4QXJyYXkpIHtcclxuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFdyaXRpbmcgQ2hhcmFjdGVyaXN0aWMgJW8nLCBjaGFyYWN0ZXJpc3RpYyk7XHJcblxyXG4gICAgcmV0dXJuIGZyb20oY2hhcmFjdGVyaXN0aWMud3JpdGVWYWx1ZSh2YWx1ZSkudGhlbihfID0+IFByb21pc2UucmVzb2x2ZSgpLCAoZXJyb3I6IERPTUV4Y2VwdGlvbikgPT4gUHJvbWlzZS5yZWplY3QoYCR7ZXJyb3IubWVzc2FnZX1gKSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQSBzdHJlYW0gb2YgRGF0YVZpZXcgdmFsdWVzIGVtaXR0ZWQgYnkgdGhlIHNwZWNpZmllZCBjaGFyYWN0ZXJpc3RpYy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMgd2hpY2ggdmFsdWUgeW91IHdhbnQgdG8gb2JzZXJ2ZVxyXG4gICAqIEByZXR1cm4gVGhlIHN0cmVhbSBvZiBEYXRhVmlldyB2YWx1ZXMuXHJcbiAgICovXHJcbiAgb2JzZXJ2ZVZhbHVlJChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKTogT2JzZXJ2YWJsZTxEYXRhVmlldz4ge1xyXG4gICAgY2hhcmFjdGVyaXN0aWMuc3RhcnROb3RpZmljYXRpb25zKCk7XHJcbiAgICBjb25zdCBkaXNjb25uZWN0ZWQgPSBmcm9tRXZlbnQoY2hhcmFjdGVyaXN0aWMuc2VydmljZS5kZXZpY2UsICdnYXR0c2VydmVyZGlzY29ubmVjdGVkJyk7XHJcbiAgICByZXR1cm4gZnJvbUV2ZW50KGNoYXJhY3RlcmlzdGljLCAnY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnKVxyXG4gICAgICAucGlwZShcclxuICAgICAgICBtYXAoKGV2ZW50OiBFdmVudCkgPT4gKGV2ZW50LnRhcmdldCBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpLnZhbHVlIGFzIERhdGFWaWV3KSxcclxuICAgICAgICB0YWtlVW50aWwoZGlzY29ubmVjdGVkKVxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQSB1dGlsaXR5IG1ldGhvZCB0byBjb252ZXJ0IExFIHRvIGFuIHVuc2lnbmVkIDE2LWJpdCBpbnRlZ2VyIHZhbHVlcy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBkYXRhIFRoZSBEYXRhVmlldyBiaW5hcnkgZGF0YS5cclxuICAgKiBAcGFyYW0gYnl0ZU9mZnNldCBUaGUgb2Zmc2V0LCBpbiBieXRlLCBmcm9tIHRoZSBzdGFydCBvZiB0aGUgdmlldyB3aGVyZSB0byByZWFkIHRoZSBkYXRhLlxyXG4gICAqIEByZXR1cm4gQW4gdW5zaWduZWQgMTYtYml0IGludGVnZXIgbnVtYmVyLlxyXG4gICAqL1xyXG4gIGxpdHRsZUVuZGlhblRvVWludDE2KGRhdGE6IGFueSwgYnl0ZU9mZnNldDogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXHJcbiAgICByZXR1cm4gKHRoaXMubGl0dGxlRW5kaWFuVG9VaW50OChkYXRhLCBieXRlT2Zmc2V0ICsgMSkgPDwgOCkgKyB0aGlzLmxpdHRsZUVuZGlhblRvVWludDgoZGF0YSwgYnl0ZU9mZnNldCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBIHV0aWxpdHkgbWV0aG9kIHRvIGNvbnZlcnQgTEUgdG8gYW4gdW5zaWduZWQgOC1iaXQgaW50ZWdlciB2YWx1ZXMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YSBUaGUgRGF0YVZpZXcgYmluYXJ5IGRhdGEuXHJcbiAgICogQHBhcmFtIGJ5dGVPZmZzZXQgVGhlIG9mZnNldCwgaW4gYnl0ZSwgZnJvbSB0aGUgc3RhcnQgb2YgdGhlIHZpZXcgd2hlcmUgdG8gcmVhZCB0aGUgZGF0YS5cclxuICAgKiBAcmV0dXJuIEFuIHVuc2lnbmVkIDgtYml0IGludGVnZXIgbnVtYmVyLlxyXG4gICAqL1xyXG4gIGxpdHRsZUVuZGlhblRvVWludDgoZGF0YTogYW55LCBieXRlT2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIGRhdGEuZ2V0VWludDgoYnl0ZU9mZnNldCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyByYW5kb20gZGF0YSAoZm9yIHRlc3RpbmcgcHVycG9zZXMgb25seSkuXHJcbiAgICpcclxuICAgKiBAcmV0dXJuIFJhbmRvbSB1bnNpZ25lZCA4LWJpdCBpbnRlZ2VyIHZhbHVlcy5cclxuICAgKi9cclxuICBmYWtlTmV4dChmYWtlVmFsdWU/OiAoKSA9PiBEYXRhVmlldykge1xyXG4gICAgaWYgKGZha2VWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGZha2VWYWx1ZSA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBkdiA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoOCkpO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXHJcbiAgICAgICAgZHYuc2V0VWludDgoMCwgKE1hdGgucmFuZG9tKCkgKiAxMTApIHwgMCk7XHJcbiAgICAgICAgcmV0dXJuIGR2O1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkLmVtaXQoZmFrZVZhbHVlKCkpO1xyXG4gIH1cclxufVxyXG4iXX0=