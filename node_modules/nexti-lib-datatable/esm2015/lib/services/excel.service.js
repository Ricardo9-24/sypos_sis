import { Injectable } from '@angular/core';
import * as FileSaver from 'file-saver';
import * as XLSX from 'xlsx';
import { CurrencyPipe, DatePipe } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
const EXCEL_TYPE = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8';
const EXCEL_EXTENSION = '.xlsx';
export class ExcelService {
    constructor(datePipe, currencyPipe) {
        this.datePipe = datePipe;
        this.currencyPipe = currencyPipe;
    }
    exportAsExcelFile(data, excelFileName) {
        const formatData = this.formatData(data);
        const ws = XLSX.utils.aoa_to_sheet(formatData);
        const wscols = [
            { wch: 1 },
            { wch: 1 },
            { wch: 35 },
            { wch: 15 },
            { wch: 15 },
            { wch: 10 },
            { wch: 16 },
            { wch: 15 },
            { wch: 20 },
            { wch: 20 },
        ];
        ws['!cols'] = wscols;
        const wb = {
            Sheets: { data: ws },
            SheetNames: ['data'],
        };
        const excelBuffer = XLSX.write(wb, {
            bookType: 'xlsx',
            type: 'array',
        });
        this.saveAsExcelFile(excelBuffer, excelFileName);
    }
    saveAsExcelFile(buffer, fileName) {
        const data = new Blob([buffer], { type: EXCEL_TYPE });
        FileSaver.saveAs(data, fileName + '_' + new Date().getTime() + EXCEL_EXTENSION);
    }
    getTableRow(array, param, whiteSpace) {
        let rowsCobradas = [];
        const commonDateForStr = 'dd/MM/yyyy';
        array.forEach((f) => {
            if (f.data.length) {
                f.data.forEach((e, i) => {
                    const fechaEmi = this.datePipe.transform(e.FechaEmision, commonDateForStr);
                    const valorFact = this.currencyPipe.transform(e.importeTotal);
                    const fechaEmiRet = this.datePipe.transform(e.FechaEmisionRet, commonDateForStr);
                    const valorRet = this.currencyPipe.transform(e.importeTotalRet);
                    const valorTotal = this.currencyPipe.transform(e[param]);
                    let actualDataRow = [
                        e.Numdoc,
                        fechaEmi,
                        valorFact,
                        e.NumdocRet,
                        fechaEmiRet,
                        valorRet,
                        valorTotal,
                    ];
                    if (i == 0) {
                        rowsCobradas.push([...whiteSpace, f.rucEmpresa, ...actualDataRow]);
                        if (f.data.length == 1) {
                            rowsCobradas.push([...whiteSpace, f.razonSocial]);
                        }
                    }
                    else if (i == 1) {
                        rowsCobradas.push([...whiteSpace, f.razonSocial, ...actualDataRow]);
                    }
                    else {
                        rowsCobradas.push([...whiteSpace, '', ...actualDataRow]);
                    }
                });
            }
            const totalFact = this.currencyPipe.transform(f.totalFact);
            const totalRet = this.currencyPipe.transform(f.totalRet);
            const totalPagado = this.currencyPipe.transform(f.totalPagado);
            // subtotal
            rowsCobradas.push([
                ...whiteSpace,
                '',
                f.cantFact,
                '',
                totalFact,
                f.cantRet,
                '',
                totalRet,
                totalPagado,
            ]);
        });
        return rowsCobradas;
    }
    formatData(data) {
        const whiteSpace = ['', ''];
        const tableHeader = [
            ...whiteSpace,
            'RUC / RAZON SOCIAL',
            'Número Factura',
            'Fecha Factura',
            'Valor Factura',
            'Número Retención',
            'Fecha Retención',
            'Valor Retención',
            'Valor Total Pagado',
        ];
        const facturasCobradas = data.cobradas;
        const facturasPagadas = data.pagadas;
        const rowsCobradas = this.getTableRow(facturasCobradas, 'totalCobrado', whiteSpace);
        const rowsPagadas = this.getTableRow(facturasPagadas, 'totalPagado', whiteSpace);
        const rowTotalCobradas = [
            ...whiteSpace,
            'TOTAL FACTURAS COBRADAS',
            data.cantCobradas,
            '',
            this.currencyPipe.transform(data.sumCobradas),
            data.cantRetCobradas,
            '',
            this.currencyPipe.transform(data.sumRetCobradas),
            this.currencyPipe.transform(data.totalCobradas),
        ];
        const rowTotalPagadas = [
            ...whiteSpace,
            'TOTAL FACTURAS PAGADAS',
            data.cantPagadas,
            '',
            this.currencyPipe.transform(data.sumPagadas),
            data.cantRetPagadas,
            '',
            this.currencyPipe.transform(data.sumRetPagadas),
            this.currencyPipe.transform(data.totalPagadas),
        ];
        const netoTotalFor = this.currencyPipe.transform(data.netoTotal);
        const rowNetos = [
            ...whiteSpace,
            'VALORES NETOS',
            '',
            '',
            this.currencyPipe.transform(data.netoFact),
            '',
            '',
            this.currencyPipe.transform(data.netoRet),
            netoTotalFor,
        ];
        const rowPosicionNeta = [
            ...whiteSpace,
            'POSICION NETA DE LA EMPRESA',
            netoTotalFor,
        ];
        const actualFormatDate = this.datePipe.transform(Date.now(), 'dd/MM/YYYY HH:mm:ss');
        return [
            [],
            [],
            // prettier-ignore
            [...whiteSpace, 'SESIÓN DE COMPENSACIÓN DEFINITIVA', '', '', '', '', '', '', actualFormatDate],
            [...whiteSpace, 'REPORTE POR EMPRESA PARTICIPANTE'],
            [],
            // prettier-ignore
            [...whiteSpace, 'EMPRESA :', data.Ruc, data.razonSocial, '', '', '', 'FECHA COMPENSACIÓN', data.fechaSesion],
            [],
            [...whiteSpace, 'FACTURAS COBRADAS'],
            tableHeader,
            ...rowsCobradas,
            rowTotalCobradas,
            [],
            [],
            [...whiteSpace, 'FACTURAS PAGADAS'],
            tableHeader,
            ...rowsPagadas,
            rowTotalPagadas,
            [],
            [...whiteSpace, 'RESUMEN PROCESO DE COMPENSACIÓN'],
            // prettier-ignore
            [...whiteSpace, '', 'Número Facturas', '', 'Valor Facturas', 'Número Retenciones', '', 'Valor Retenciones', 'Valor Total'],
            [],
            rowTotalCobradas,
            rowTotalPagadas,
            rowNetos,
            [],
            rowPosicionNeta,
        ];
    }
}
ExcelService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ExcelService_Factory() { return new ExcelService(i0.ɵɵinject(i1.DatePipe), i0.ɵɵinject(i1.CurrencyPipe)); }, token: ExcelService, providedIn: "root" });
ExcelService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
ExcelService.ctorParameters = () => [
    { type: DatePipe },
    { type: CurrencyPipe }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjZWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25leHRpLWxpYi1kYXRhdGFibGUvc3JjL2xpYi9zZXJ2aWNlcy9leGNlbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxLQUFLLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDeEMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7O0FBRXpELE1BQU0sVUFBVSxHQUNkLGlGQUFpRixDQUFDO0FBQ3BGLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQztBQUtoQyxNQUFNLE9BQU8sWUFBWTtJQUN2QixZQUFvQixRQUFrQixFQUFVLFlBQTBCO1FBQXRELGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztJQUFHLENBQUM7SUFFdkUsaUJBQWlCLENBQUMsSUFBVyxFQUFFLGFBQXFCO1FBQ3pELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsTUFBTSxFQUFFLEdBQW1CLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9ELE1BQU0sTUFBTSxHQUFHO1lBQ2IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFO1lBQ1YsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFO1lBQ1YsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO1lBQ1gsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO1lBQ1gsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO1lBQ1gsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO1lBQ1gsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFF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bEQsa0JBQWtCO1lBQ2xCLENBQUMsR0FBRyxVQUFVLEVBQUUsRUFBRSxFQUFFLGlCQUFpQixFQUFFLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxvQkFBb0IsRUFBRSxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsYUFBYSxDQUFDO1lBQzFILEVBQUU7WUFDRixnQkFBZ0I7WUFDaEIsZUFBZTtZQUNmLFFBQVE7WUFDUixFQUFFO1lBQ0YsZUFBZTtTQUNoQixDQUFDO0lBQ0osQ0FBQzs7OztZQWpORixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQVJzQixRQUFRO1lBQXRCLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCAqIGFzIEZpbGVTYXZlciBmcm9tICdmaWxlLXNhdmVyJztcclxuaW1wb3J0ICogYXMgWExTWCBmcm9tICd4bHN4JztcclxuaW1wb3J0IHsgQ3VycmVuY3lQaXBlLCBEYXRlUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcblxyXG5jb25zdCBFWENFTF9UWVBFID1cclxuICAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQ7Y2hhcnNldD1VVEYtOCc7XHJcbmNvbnN0IEVYQ0VMX0VYVEVOU0lPTiA9ICcueGxzeCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRXhjZWxTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGVQaXBlOiBEYXRlUGlwZSwgcHJpdmF0ZSBjdXJyZW5jeVBpcGU6IEN1cnJlbmN5UGlwZSkge31cclxuXHJcbiAgcHVibGljIGV4cG9ydEFzRXhjZWxGaWxlKGRhdGE6IGFueVtdLCBleGNlbEZpbGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IGZvcm1hdERhdGEgPSB0aGlzLmZvcm1hdERhdGEoZGF0YSk7XHJcbiAgICBjb25zdCB3czogWExTWC5Xb3JrU2hlZXQgPSBYTFNYLnV0aWxzLmFvYV90b19zaGVldChmb3JtYXREYXRhKTtcclxuICAgIGNvbnN0IHdzY29scyA9IFtcclxuICAgICAgeyB3Y2g6IDEgfSxcclxuICAgICAgeyB3Y2g6IDEgfSxcclxuICAgICAgeyB3Y2g6IDM1IH0sXHJcbiAgICAgIHsgd2NoOiAxNSB9LFxyXG4gICAgICB7IHdjaDogMTUgfSxcclxuICAgICAgeyB3Y2g6IDEwIH0sXHJcbiAgICAgIHsgd2NoOiAxNiB9LFxyXG4gICAgICB7IHdjaDogMTUgfSxcclxuICAgICAgeyB3Y2g6IDIwIH0sXHJcbiAgICAgIHsgd2NoOiAyMCB9LFxyXG4gICAgXTtcclxuICAgIHdzWychY29scyddID0gd3Njb2xzO1xyXG5cclxuICAgIGNvbnN0IHdiOiBYTFNYLldvcmtCb29rID0ge1xyXG4gICAgICBTaGVldHM6IHsgZGF0YTogd3MgfSxcclxuICAgICAgU2hlZXROYW1lczogWydkYXRhJ10sXHJcbiAgICB9O1xyXG4gICAgY29uc3QgZXhjZWxCdWZmZXI6IGFueSA9IFhMU1gud3JpdGUod2IsIHtcclxuICAgICAgYm9va1R5cGU6ICd4bHN4JyxcclxuICAgICAgdHlwZTogJ2FycmF5JyxcclxuICAgIH0pO1xyXG4gICAgdGhpcy5zYXZlQXNFeGNlbEZpbGUoZXhjZWxCdWZmZXIsIGV4Y2VsRmlsZU5hbWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzYXZlQXNFeGNlbEZpbGUoYnVmZmVyOiBhbnksIGZpbGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IGRhdGE6IEJsb2IgPSBuZXcgQmxvYihbYnVmZmVyXSwgeyB0eXBlOiBFWENFTF9UWVBFIH0pO1xyXG4gICAgRmlsZVNhdmVyLnNhdmVBcyhcclxuICAgICAgZGF0YSxcclxuICAgICAgZmlsZU5hbWUgKyAnXycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSArIEVYQ0VMX0VYVEVOU0lPTlxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGdldFRhYmxlUm93KGFycmF5LCBwYXJhbSwgd2hpdGVTcGFjZSkge1xyXG4gICAgbGV0IHJvd3NDb2JyYWRhcyA9IFtdO1xyXG4gICAgY29uc3QgY29tbW9uRGF0ZUZvclN0ciA9ICdkZC9NTS95eXl5JztcclxuXHJcbiAgICBhcnJheS5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGYuZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICBmLmRhdGEuZm9yRWFjaCgoZTogYW55LCBpOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGZlY2hhRW1pID0gdGhpcy5kYXRlUGlwZS50cmFuc2Zvcm0oXHJcbiAgICAgICAgICAgIGUuRmVjaGFFbWlzaW9uLFxyXG4gICAgICAgICAgICBjb21tb25EYXRlRm9yU3RyXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgY29uc3QgdmFsb3JGYWN0ID0gdGhpcy5jdXJyZW5jeVBpcGUudHJhbnNmb3JtKGUuaW1wb3J0ZVRvdGFsKTtcclxuICAgICAgICAgIGNvbnN0IGZlY2hhRW1pUmV0ID0gdGhpcy5kYXRlUGlwZS50cmFuc2Zvcm0oXHJcbiAgICAgICAgICAgIGUuRmVjaGFFbWlzaW9uUmV0LFxyXG4gICAgICAgICAgICBjb21tb25EYXRlRm9yU3RyXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgY29uc3QgdmFsb3JSZXQgPSB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZS5pbXBvcnRlVG90YWxSZXQpO1xyXG4gICAgICAgICAgY29uc3QgdmFsb3JUb3RhbCA9IHRoaXMuY3VycmVuY3lQaXBlLnRyYW5zZm9ybShlW3BhcmFtXSk7XHJcblxyXG4gICAgICAgICAgbGV0IGFjdHVhbERhdGFSb3cgPSBbXHJcbiAgICAgICAgICAgIGUuTnVtZG9jLFxyXG4gICAgICAgICAgICBmZWNoYUVtaSxcclxuICAgICAgICAgICAgdmFsb3JGYWN0LFxyXG4gICAgICAgICAgICBlLk51bWRvY1JldCxcclxuICAgICAgICAgICAgZmVjaGFFbWlSZXQsXHJcbiAgICAgICAgICAgIHZhbG9yUmV0LFxyXG4gICAgICAgICAgICB2YWxvclRvdGFsLFxyXG4gICAgICAgICAgXTtcclxuXHJcbiAgICAgICAgICBpZiAoaSA9PSAwKSB7XHJcbiAgICAgICAgICAgIHJvd3NDb2JyYWRhcy5wdXNoKFsuLi53aGl0ZVNwYWNlLCBmLnJ1Y0VtcHJlc2EsIC4uLmFjdHVhbERhdGFSb3ddKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChmLmRhdGEubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgICByb3dzQ29icmFkYXMucHVzaChbLi4ud2hpdGVTcGFjZSwgZi5yYXpvblNvY2lhbF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGkgPT0gMSkge1xyXG4gICAgICAgICAgICByb3dzQ29icmFkYXMucHVzaChbLi4ud2hpdGVTcGFjZSwgZi5yYXpvblNvY2lhbCwgLi4uYWN0dWFsRGF0YVJvd10pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcm93c0NvYnJhZGFzLnB1c2goWy4uLndoaXRlU3BhY2UsICcnLCAuLi5hY3R1YWxEYXRhUm93XSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdG90YWxGYWN0ID0gdGhpcy5jdXJyZW5jeVBpcGUudHJhbnNmb3JtKGYudG90YWxGYWN0KTtcclxuICAgICAgY29uc3QgdG90YWxSZXQgPSB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZi50b3RhbFJldCk7XHJcbiAgICAgIGNvbnN0IHRvdGFsUGFnYWRvID0gdGhpcy5jdXJyZW5jeVBpcGUudHJhbnNmb3JtKGYudG90YWxQYWdhZG8pO1xyXG4gICAgICAvLyBzdWJ0b3RhbFxyXG4gICAgICByb3dzQ29icmFkYXMucHVzaChbXHJcbiAgICAgICAgLi4ud2hpdGVTcGFjZSxcclxuICAgICAgICAnJyxcclxuICAgICAgICBmLmNhbnRGYWN0LFxyXG4gICAgICAgICcnLFxyXG4gICAgICAgIHRvdGFsRmFjdCxcclxuICAgICAgICBmLmNhbnRSZXQsXHJcbiAgICAgICAgJycsXHJcbiAgICAgICAgdG90YWxSZXQsXHJcbiAgICAgICAgdG90YWxQYWdhZG8sXHJcbiAgICAgIF0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHJvd3NDb2JyYWRhcztcclxuICB9XHJcblxyXG4gIGZvcm1hdERhdGEoZGF0YSkge1xyXG4gICAgY29uc3Qgd2hpdGVTcGFjZSA9IFsnJywgJyddO1xyXG4gICAgY29uc3QgdGFibGVIZWFkZXIgPSBbXHJcbiAgICAgIC4uLndoaXRlU3BhY2UsXHJcbiAgICAgICdSVUMgLyBSQVpPTiBTT0NJQUwnLFxyXG4gICAgICAnTsO6bWVybyBGYWN0dXJhJyxcclxuICAgICAgJ0ZlY2hhIEZhY3R1cmEnLFxyXG4gICAgICAnVmFsb3IgRmFjdHVyYScsXHJcbiAgICAgICdOw7ptZXJvIFJldGVuY2nDs24nLFxyXG4gICAgICAnRmVjaGEgUmV0ZW5jacOzbicsXHJcbiAgICAgICdWYWxvciBSZXRlbmNpw7NuJyxcclxuICAgICAgJ1ZhbG9yIFRvdGFsIFBhZ2FkbycsXHJcbiAgICBdO1xyXG4gICAgY29uc3QgZmFjdHVyYXNDb2JyYWRhczogW10gPSBkYXRhLmNvYnJhZGFzO1xyXG4gICAgY29uc3QgZmFjdHVyYXNQYWdhZGFzOiBbXSA9IGRhdGEucGFnYWRhcztcclxuICAgIGNvbnN0IHJvd3NDb2JyYWRhcyA9IHRoaXMuZ2V0VGFibGVSb3coXHJcbiAgICAgIGZhY3R1cmFzQ29icmFkYXMsXHJcbiAgICAgICd0b3RhbENvYnJhZG8nLFxyXG4gICAgICB3aGl0ZVNwYWNlXHJcbiAgICApO1xyXG4gICAgY29uc3Qgcm93c1BhZ2FkYXMgPSB0aGlzLmdldFRhYmxlUm93KFxyXG4gICAgICBmYWN0dXJhc1BhZ2FkYXMsXHJcbiAgICAgICd0b3RhbFBhZ2FkbycsXHJcbiAgICAgIHdoaXRlU3BhY2VcclxuICAgICk7XHJcblxyXG4gICAgY29uc3Qgcm93VG90YWxDb2JyYWRhcyA9IFtcclxuICAgICAgLi4ud2hpdGVTcGFjZSxcclxuICAgICAgJ1RPVEFMIEZBQ1RVUkFTIENPQlJBREFTJyxcclxuICAgICAgZGF0YS5jYW50Q29icmFkYXMsXHJcbiAgICAgICcnLFxyXG4gICAgICB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZGF0YS5zdW1Db2JyYWRhcyksXHJcbiAgICAgIGRhdGEuY2FudFJldENvYnJhZGFzLFxyXG4gICAgICAnJyxcclxuICAgICAgdGhpcy5jdXJyZW5jeVBpcGUudHJhbnNmb3JtKGRhdGEuc3VtUmV0Q29icmFkYXMpLFxyXG4gICAgICB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZGF0YS50b3RhbENvYnJhZGFzKSxcclxuICAgIF07XHJcblxyXG4gICAgY29uc3Qgcm93VG90YWxQYWdhZGFzID0gW1xyXG4gICAgICAuLi53aGl0ZVNwYWNlLFxyXG4gICAgICAnVE9UQUwgRkFDVFVSQVMgUEFHQURBUycsXHJcbiAgICAgIGRhdGEuY2FudFBhZ2FkYXMsXHJcbiAgICAgICcnLFxyXG4gICAgICB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZGF0YS5zdW1QYWdhZGFzKSxcclxuICAgICAgZGF0YS5jYW50UmV0UGFnYWRhcyxcclxuICAgICAgJycsXHJcbiAgICAgIHRoaXMuY3VycmVuY3lQaXBlLnRyYW5zZm9ybShkYXRhLnN1bVJldFBhZ2FkYXMpLFxyXG4gICAgICB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZGF0YS50b3RhbFBhZ2FkYXMpLFxyXG4gICAgXTtcclxuICAgIGNvbnN0IG5ldG9Ub3RhbEZvciA9IHRoaXMuY3VycmVuY3lQaXBlLnRyYW5zZm9ybShkYXRhLm5ldG9Ub3RhbCk7XHJcblxyXG4gICAgY29uc3Qgcm93TmV0b3MgPSBbXHJcbiAgICAgIC4uLndoaXRlU3BhY2UsXHJcbiAgICAgICdWQUxPUkVTIE5FVE9TJyxcclxuICAgICAgJycsXHJcbiAgICAgICcnLFxyXG4gICAgICB0aGlzLmN1cnJlbmN5UGlwZS50cmFuc2Zvcm0oZGF0YS5uZXRvRmFjdCksXHJcbiAgICAgICcnLFxyXG4gICAgICAnJyxcclxuICAgICAgdGhpcy5jdXJyZW5jeVBpcGUudHJhbnNmb3JtKGRhdGEubmV0b1JldCksXHJcbiAgICAgIG5ldG9Ub3RhbEZvcixcclxuICAgIF07XHJcblxyXG4gICAgY29uc3Qgcm93UG9zaWNpb25OZXRhID0gW1xyXG4gICAgICAuLi53aGl0ZVNwYWNlLFxyXG4gICAgICAnUE9TSUNJT04gTkVUQSBERSBMQSBFTVBSRVNBJyxcclxuICAgICAgbmV0b1RvdGFsRm9yLFxyXG4gICAgXTtcclxuXHJcbiAgICBjb25zdCBhY3R1YWxGb3JtYXREYXRlID0gdGhpcy5kYXRlUGlwZS50cmFuc2Zvcm0oXHJcbiAgICAgIERhdGUubm93KCksXHJcbiAgICAgICdkZC9NTS9ZWVlZIEhIOm1tOnNzJ1xyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gW1xyXG4gICAgICBbXSxcclxuICAgICAgW10sXHJcbiAgICAgIC8vIHByZXR0aWVyLWlnbm9yZVxyXG4gICAgICBbLi4ud2hpdGVTcGFjZSwgJ1NFU0nDk04gREUgQ09NUEVOU0FDScOTTiBERUZJTklUSVZBJywgJycsICcnLCAnJywgJycsICcnLCAnJywgYWN0dWFsRm9ybWF0RGF0ZV0sXHJcbiAgICAgIFsuLi53aGl0ZVNwYWNlLCAnUkVQT1JURSBQT1IgRU1QUkVTQSBQQVJUSUNJUEFOVEUnXSxcclxuICAgICAgW10sXHJcbiAgICAgIC8vIHByZXR0aWVyLWlnbm9yZVxyXG4gICAgICBbLi4ud2hpdGVTcGFjZSwgJ0VNUFJFU0EgOicsIGRhdGEuUnVjLCBkYXRhLnJhem9uU29jaWFsLCAnJywgJycsICcnLCAnRkVDSEEgQ09NUEVOU0FDScOTTicsIGRhdGEuZmVjaGFTZXNpb25dLFxyXG4gICAgICBbXSxcclxuICAgICAgWy4uLndoaXRlU3BhY2UsICdGQUNUVVJBUyBDT0JSQURBUyddLFxyXG4gICAgICB0YWJsZUhlYWRlcixcclxuICAgICAgLi4ucm93c0NvYnJhZGFzLFxyXG4gICAgICByb3dUb3RhbENvYnJhZGFzLFxyXG4gICAgICBbXSxcclxuICAgICAgW10sXHJcbiAgICAgIFsuLi53aGl0ZVNwYWNlLCAnRkFDVFVSQVMgUEFHQURBUyddLFxyXG4gICAgICB0YWJsZUhlYWRlcixcclxuICAgICAgLi4ucm93c1BhZ2FkYXMsXHJcbiAgICAgIHJvd1RvdGFsUGFnYWRhcyxcclxuICAgICAgW10sXHJcbiAgICAgIFsuLi53aGl0ZVNwYWNlLCAnUkVTVU1FTiBQUk9DRVNPIERFIENPTVBFTlNBQ0nDk04nXSxcclxuICAgICAgLy8gcHJldHRpZXItaWdub3JlXHJcbiAgICAgIFsuLi53aGl0ZVNwYWNlLCAnJywgJ07Dum1lcm8gRmFjdHVyYXMnLCAnJywgJ1ZhbG9yIEZhY3R1cmFzJywgJ07Dum1lcm8gUmV0ZW5jaW9uZXMnLCAnJywgJ1ZhbG9yIFJldGVuY2lvbmVzJywgJ1ZhbG9yIFRvdGFsJ10sXHJcbiAgICAgIFtdLFxyXG4gICAgICByb3dUb3RhbENvYnJhZGFzLFxyXG4gICAgICByb3dUb3RhbFBhZ2FkYXMsXHJcbiAgICAgIHJvd05ldG9zLFxyXG4gICAgICBbXSxcclxuICAgICAgcm93UG9zaWNpb25OZXRhLFxyXG4gICAgXTtcclxuICB9XHJcbn1cclxuIl19